<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Design and implementation - Unitful.jl</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">Unitful.jl</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">Design and implementation</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Miscellaneous <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../releases/">Release notes</a>
</li>

                        
                            
<li >
    <a href="../LICENSE/">License</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="..">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../releases/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/ajkeller34/Unitful.jl/">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#design-and-implementation">Design and implementation</a></li>
        
            <li><a href="#a-view-from-30000-ft-or-9144-m">A view from 30000 ft (or 9144 m)</a></li>
        
            <li><a href="#creating-new-units">Creating new units</a></li>
        
            <li><a href="#conversion-and-promotions">Conversion and promotions</a></li>
        
            <li><a href="#temperature-conversion">Temperature conversion</a></li>
        
            <li><a href="#discussion">Discussion</a></li>
        
            <li><a href="#potential-improvements-to-base">Potential improvements to Base</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="design-and-implementation">Design and implementation</h1>
<h2 id="a-view-from-30000-ft-or-9144-m">A view from 30000 ft (or 9144 m)</h2>
<p>Like SIUnits.jl, units are part of the type signature of a quantity. From there,
the implementations diverge. Unitful.jl uses generated functions to enable more
flexibility than found in SIUnits.jl. Support is targeted to Julia 0.5+
because of some limitations in how <code>promote_op</code> is used in Julia 0.4. See
<a href="https://github.com/julialang/Julia/issues/13803">issue #13803</a>.</p>
<p>We make an immutable <code>UnitDatum</code> that stores a base unit (expressed a bits type
generated by an <code>@enum</code>), a rational exponent, and a prefix. We don't allow
arbitrary floating point exponents of units because they probably aren't very useful.
The prefixes on units (e.g. <code>nm</code> or <code>km</code>) may help to avoid overflow issues
and general ugliness.</p>
<p>We define the immutable singleton <code>UnitData{T}</code>, where <code>T</code> is always a tuple
of <code>UnitDatum</code> (variable number of arguments). Usually, the user interacts
only with <code>UnitData{T}</code> objects, not <code>UnitDatum</code>.</p>
<p>We define methods <code>dimension</code> that turn, for example, <code>acre^2</code> into <code>[L]^4</code>.
We can in principle add quantities with the same dimension
(<code>acre [L]^2 + ft^2 [L]^2</code>), provided some "promotion" rules are given (see below).
Note that dimensions cannot be determined
by powers of the units: <code>ft^2</code> is an area, but so is <code>acre^1</code>.</p>
<p>We define unitful <em>Quantities</em> <code>RealQuantity{T&lt;:Real, Units}</code> and
<code>FloatQuantity{T&lt;:AbstractFloat, Units}</code> where <code>Units</code> is
a type <code>UnitData{T}</code>. To play nicely with <code>FloatRange</code> and <code>LinSpace</code>, we need
<code>FloatQuantity &lt;: AbstractFloat</code>; we also have <code>RealQuantity &lt;: Real</code>.
By putting units in the type signature of a quantity,
staged functions can be used to offload
as much of the unit computation to compile-time as is possible.</p>
<h2 id="creating-new-units">Creating new units</h2>
<p>A user interface for creating new units is as-of-yet non-existent. However, it
is not hard to modify this package to create units.</p>
<p>Add the unit to the enumeration beginning with <code>@enum(Unit,</code>. Give
a method for <code>abbr</code> which specifies a string to display the unit, a
method for <code>dimension</code> that tells the dimensions, and finally a method
for <code>basefactor</code>. This should
specify what one of this unit corresponds to in equivalent base SI units.
Looking at the code should clarify this. Finally, for ease of use you may want
to define a constant for the new unit (or perhaps constants plural, if you want
powers-of-ten prefixes). Look at <code>Defaults.jl</code> for how this is done.</p>
<p>Some care should be taken if explicitly making <code>UnitData</code> objects. The ordering
of <code>UnitDatum</code> inside a tuple matters for type comparisons. Using the unary
multiplication operator on the <code>UnitData</code> object will return a "canonically sorted"
<code>UnitData</code> object. Indeed, this is how we avoid ordering issues when multiplying
quantities together.</p>
<h2 id="conversion-and-promotions">Conversion and promotions</h2>
<p>Conversions between units are rejected if the units have different dimensions.</p>
<p>We decide the result units for addition and subtraction operations based
on looking at the unit types only. We can't take runtime values into account
without compromising runtime performance. By default, if we
have <code>x (A) + y (B) = z (C)</code> where <code>x,y,z</code> are numbers and <code>A,B,C</code> are units,
then <code>C = max(1A, 1B)</code>. This is an arbitrary choice and can be changed in
<code>Defaults.jl</code>. For example,
<code>101cm + 1m = 2.01m</code> because <code>1m &gt; 1cm</code>.</p>
<p>Although quantities could be integrated with Julia's promotion mechanisms,
we instead simply define how to add or subtract the units themselves,
and have addition of quantities rely on those definitions.
The concern is that implicit promotion operations
that were written with pure numbers in mind may give rise to surprising
behavior without returning errors. The operations on the numeric values of
quantities of course utilize Julia's promotion mechanisms.</p>
<p>Some of our <code>convert</code> syntax breaks Julia conventions in that the first
argument is not a type. For example, <code>convert(ft, 1m)</code> converts 1 meter to feet.
This may rub people the wrong way and could change. A neat alternative would be
to override other syntax: <code>3m in cm</code> would be succinct and intuitive.
Overriding <code>in</code> is simple, but the parsing rules aren't intended for this.
For example, <code>0°C in °F ≈ 32°F</code> fails to evaluate, but <code>(0°C in °F) ≈ 32°F</code>
returns <code>true</code>.</p>
<h2 id="temperature-conversion">Temperature conversion</h2>
<p>If a unit is a pure temperature unit, then conversion respects scale offsets.
For instance, converting 0°C to °F returns the expected result, 32°F (± some
small floating point discrepancy). If instead temperature appears in
combination with other units, scale offsets don't make sense and we
consider temperature <em>intervals</em>. This gives the expected behavior most of the
time.</p>
<h2 id="discussion">Discussion</h2>
<ul>
<li>
<p>If there is a need for complex numbers to have units, please implement that
and submit a PR, adding tests where appropriate.</p>
</li>
<li>
<p><a href="https://github.com/Keno/SIUnits.jl/issues/18">SIUnits issue 18</a>: Some discussion
regarding how to define <code>one(x)</code> and <code>zero(x)</code> for quantities with units. Right now
<code>one(x)</code> returns no units, but <code>zero(x)</code> returns units. This is consistent with
Julia documentation; <code>one(x)</code> should be multiplicative identity and <code>zero(x)</code>
should be additive identity.</p>
</li>
</ul>
<h2 id="potential-improvements-to-base">Potential improvements to Base</h2>
<p>In writing this package I’ve noticed a few places where changes to Base could be helpful. I keep redefinitions of methods found in Base in <code>Redefinitions.jl</code>. If I receive some encouraging feedback from a Julia contributor, maybe I’ll submit a PR. In the meantime, try not to be annoyed by the redefinition warnings.</p>
<p>To give a flavor of the kind of changes I suggest, here is an example.
According to the documentation, <code>one(x)</code> is supposed to be the multiplicative identity for the type of x. There are several places in <code>base/range.jl</code>, for example, where <code>one(x)</code> is being used instead of <code>oftype(x,1)</code>. This distinction could be important for types with units:
<code>(1m) * one(1m) == 1m</code>, but <code>1m+oftype(1m, 1) == 2m</code>, and <code>1m+one(1m)</code> is invalid
since we cannot add unitful and unitless quantities.</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
